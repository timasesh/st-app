{% extends 'courses/student_base.html' %}
{% load static %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–≤–∏–∑–∞{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –∫–≤–∏–∑–æ–≤ */
.sound-controls {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.sound-toggle-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.sound-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.sound-toggle-btn:active {
    transform: scale(0.95);
}

.sound-toggle-btn i {
    transition: all 0.3s ease;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–≤—É–∫–∞ */
@keyframes soundPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.sound-toggle-btn.playing {
    animation: soundPulse 0.3s ease;
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 768px) {
    .sound-controls {
        top: 15px;
        right: 15px;
    }
    
    .sound-toggle-btn {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
    }
}

/* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –∑–≤—É–∫–∞ */
.btn-home.playing, .btn-retry.playing {
    animation: buttonPulse 0.3s ease;
}

@keyframes buttonPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}

{% block content %}
<div class="quiz-result-container">
    <div class="result-card">
        <div class="result-header">
            <h2>{{ quiz.title }}</h2>
            <div class="result-badge {% if attempt.passed %}passed{% else %}failed{% endif %}">
                {% if attempt.passed %}
                    <i class="fas fa-check-circle"></i>
                    <span>–ü—Ä–æ–π–¥–µ–Ω</span>
                {% else %}
                    <i class="fas fa-times-circle"></i>
                    <span>–ù–µ –ø—Ä–æ–π–¥–µ–Ω</span>
                {% endif %}
            </div>
        </div>
        
        <div class="score-section">
            <div class="score-circle {% if attempt.score == 100 %}perfect{% elif attempt.passed %}good{% else %}poor{% endif %}">
                <div class="score-number">{{ attempt.score|floatformat:0 }}%</div>
                <div class="score-label">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
            </div>
        </div>
        
        {% if attempt.score == 100 %}
        <div class="perfect-score-celebration">
            <div class="celebration-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <h3>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ</h3>
            <p>–í—ã –ø–æ–ª—É—á–∏–ª–∏ <strong>{{ quiz.stars }}</strong> –∑–≤–µ–∑–¥ –∑–∞ –∏–¥–µ–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ!</p>
            <div class="stars-earned">
                {% for i in "123"|make_list %}
                    <i class="fas fa-star"></i>
                {% endfor %}
            </div>
        </div>
        {% elif attempt.passed %}
        <div class="passed-message">
            <div class="message-icon">
                <i class="fas fa-thumbs-up"></i>
            </div>
            <h3>–û—Ç–ª–∏—á–Ω–æ!</h3>
            <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –∫–≤–∏–∑!</p>
        </div>
        {% else %}
        <div class="failed-message">
            <div class="message-icon">
                <i class="fas fa-lightbulb"></i>
            </div>
            <h3>–ù–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ—Å—å!</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
        </div>
        {% endif %}
        
        <div class="result-actions">
            <a href="{% url 'student_page' %}" class="btn-home">
                <i class="fas fa-home"></i>
                –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
            {% if attempt.score != 100 %}
            <a href="{% url 'student_start_quiz' quiz.id %}" class="btn-retry">
                <i class="fas fa-redo"></i>
                –ü—Ä–æ–π—Ç–∏ –µ—â–µ —Ä–∞–∑
            </a>
            {% endif %}
        </div>
    </div>
</div>

<style>
.quiz-result-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60vh;
    padding: 2rem;
}

.result-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 3rem;
    text-align: center;
    color: white;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    max-width: 500px;
    width: 100%;
}

.result-header {
    margin-bottom: 2rem;
}

.result-header h2 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: white;
}

.result-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 1.1rem;
}

.result-badge.passed {
    background: rgba(40, 167, 69, 0.9);
    color: white;
}

.result-badge.failed {
    background: rgba(220, 53, 69, 0.9);
    color: white;
}

.result-badge i {
    font-size: 1.2rem;
}

.score-section {
    margin-bottom: 2rem;
}

.score-circle {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: 0 auto;
    border: 4px solid rgba(255,255,255,0.3);
}

.score-circle.perfect {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #333;
}

.score-circle.good {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.score-circle.poor {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
}

.score-number {
    font-size: 2.5rem;
    font-weight: 900;
    line-height: 1;
}

.score-label {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}

.perfect-score-celebration {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
}

.celebration-icon {
    font-size: 3rem;
    color: #ffd700;
    margin-bottom: 1rem;
}

.perfect-score-celebration h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: #ffd700;
}

.perfect-score-celebration p {
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.stars-earned {
    font-size: 2rem;
    color: #ffd700;
}

.passed-message, .failed-message {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
}

.message-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.passed-message .message-icon {
    color: #28a745;
}

.failed-message .message-icon {
    color: #ffc107;
}

.passed-message h3, .failed-message h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.result-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-home, .btn-retry {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-home {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
}

.btn-home:hover {
    background: rgba(255,255,255,0.3);
    color: white;
    text-decoration: none;
}

.btn-retry {
    background: #ffd700;
    color: #333;
    border: 2px solid #ffd700;
}

.btn-retry:hover {
    background: #ffed4e;
    color: #333;
    text-decoration: none;
    transform: translateY(-2px);
}

@media (max-width: 576px) {
    .result-card {
        padding: 2rem 1.5rem;
    }
    
    .result-header h2 {
        font-size: 1.5rem;
    }
    
    .score-circle {
        width: 120px;
        height: 120px;
    }
    
    .score-number {
        font-size: 2rem;
    }
    
    .result-actions {
        flex-direction: column;
    }
}
</style>

<!-- –ó–≤—É–∫–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ -->
<div class="sound-controls">
    <button id="toggleSound" class="sound-toggle-btn" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–∏">
        <i class="fas fa-volume-up" id="soundIcon"></i>
    </button>
</div>

<script>
// –ó–≤—É–∫–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –¥–ª—è –∫–≤–∏–∑–æ–≤
class QuizSounds {
    constructor() {
        this.audioContext = null;
        this.sounds = {};
        this.isEnabled = true;
        this.volume = 0.3;
        this.init();
    }

    init() {
        try {
            // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–æ–≤
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.createSounds();
        } catch (error) {
            console.log('AudioContext –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∑–≤—É–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã');
            this.isEnabled = false;
        }
    }

    createSounds() {
        // –ó–≤—É–∫ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–∫–æ—Ä–æ—Ç–∫–∏–π –∫–ª–∏–∫)
        this.sounds.answerSelect = this.createTone(800, 0.1, 'sine');
        
        // –ó–≤—É–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (—Ä–∞–¥–æ—Å—Ç–Ω—ã–π –∑–≤—É–∫)
        this.sounds.correctAnswer = this.createTone(1000, 0.2, 'sine');
        
        // –ó–≤—É–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫)
        this.sounds.wrongAnswer = this.createTone(400, 0.15, 'sawtooth');
        
        // –ó–≤—É–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–∏–∑–∞ (—Ç—Ä–∏—É–º—Ñ–∞–ª—å–Ω—ã–π –∑–≤—É–∫)
        this.sounds.quizComplete = this.createCompletionSound();
        
        // –ó–≤—É–∫ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞
        this.sounds.quizStart = this.createTone(600, 0.3, 'triangle');
    }

    createTone(frequency, duration, type = 'sine') {
        return () => {
            if (!this.isEnabled || !this.audioContext) return;

            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);

            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
            oscillator.type = type;

            gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(this.volume, this.audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + duration);
        };
    }

    createCompletionSound() {
        return () => {
            if (!this.isEnabled || !this.audioContext) return;

            const now = this.audioContext.currentTime;
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–≤—É–∫–æ–≤ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            const frequencies = [523, 659, 784, 1047]; // C, E, G, C (–æ–∫—Ç–∞–≤–∞ –≤—ã—à–µ)
            
            frequencies.forEach((freq, index) => {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(freq, now);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, now + index * 0.1);
                gainNode.gain.linearRampToValueAtTime(this.volume, now + index * 0.1 + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + index * 0.1 + 0.3);

                oscillator.start(now + index * 0.1);
                oscillator.stop(now + index * 0.1 + 0.3);
            });
        };
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
    playAnswerSelect() {
        if (this.sounds.answerSelect) {
            this.sounds.answerSelect();
        }
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    playCorrectAnswer() {
        if (this.sounds.correctAnswer) {
            this.sounds.correctAnswer();
        }
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    playWrongAnswer() {
        if (this.sounds.wrongAnswer) {
            this.sounds.wrongAnswer();
        }
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–∏–∑–∞
    playQuizComplete() {
        if (this.sounds.quizComplete) {
            this.sounds.quizComplete();
        }
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞
    playQuizStart() {
        if (this.sounds.quizStart) {
            this.sounds.quizStart();
        }
    }

    // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–∏
    toggleSound() {
        this.isEnabled = !this.isEnabled;
        return this.isEnabled;
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
    setVolume(volume) {
        this.volume = Math.max(0, Math.min(1, volume));
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–≤—É–∫–æ–≤
    isSoundEnabled() {
        return this.isEnabled;
    }
}

// –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∑–≤—É–∫–æ–≤
window.quizSounds = new QuizSounds();

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
function playAnswerSelect() {
    if (window.quizSounds) {
        window.quizSounds.playAnswerSelect();
    }
}

function playCorrectAnswer() {
    if (window.quizSounds) {
        window.quizSounds.playCorrectAnswer();
    }
}

function playWrongAnswer() {
    if (window.quizSounds) {
        window.quizSounds.playWrongAnswer();
    }
}

function playQuizComplete() {
    if (window.quizSounds) {
        window.quizSounds.playQuizComplete();
    }
}

function playQuizStart() {
    if (window.quizSounds) {
        window.quizSounds.playQuizStart();
    }
}

function toggleQuizSound() {
    if (window.quizSounds) {
        return window.quizSounds.toggleSound();
    }
    return false;
}

document.addEventListener('DOMContentLoaded', function() {
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    setTimeout(() => {
        const score = {{ attempt.score|floatformat:0 }};
        if (score === 100) {
            playQuizComplete(); // –¢—Ä–∏—É–º—Ñ–∞–ª—å–Ω—ã–π –∑–≤—É–∫ –¥–ª—è 100%
        } else if (score >= 70) {
            playCorrectAnswer(); // –†–∞–¥–æ—Å—Ç–Ω—ã–π –∑–≤—É–∫ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
        } else {
            playWrongAnswer(); // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫ –¥–ª—è –Ω–µ—É–¥–∞—á–∏
        }
    }, 500);

    // –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–æ–≤
    const toggleSoundBtn = document.getElementById('toggleSound');
    const soundIcon = document.getElementById('soundIcon');
    
    if (toggleSoundBtn) {
        toggleSoundBtn.addEventListener('click', function() {
            const isEnabled = toggleQuizSound();
            if (isEnabled) {
                soundIcon.className = 'fas fa-volume-up';
                toggleSoundBtn.title = '–í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–∏';
            } else {
                soundIcon.className = 'fas fa-volume-mute';
                toggleSoundBtn.title = '–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–∏';
            }
        });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
    const actionButtons = document.querySelectorAll('.btn-home, .btn-retry');
    actionButtons.forEach(button => {
        button.addEventListener('click', function() {
            playAnswerSelect();
        });
    });
});
</script>
{% endblock %}
